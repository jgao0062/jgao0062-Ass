<template>
    <nav class="navbar navbar-expand-lg sticky-top">
      <div class="container">
        <router-link to="/" class="navbar-brand">
          <i class="fas fa-heartbeat"></i> Melbourne Community Sports Health
        </router-link>
        <button
          class="navbar-toggler"
          type="button"
          @click="toggleMobileMenu"
          :aria-expanded="showMobileMenu"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse" :class="{ 'show': showMobileMenu }">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <router-link to="/" class="nav-link" @click="closeMobileMenu">Home</router-link>
            </li>
            <li class="nav-item">
              <router-link to="/programs" class="nav-link" @click="closeMobileMenu">Programs</router-link>
            </li>
            <li class="nav-item">
              <router-link to="/register" class="nav-link" @click="closeMobileMenu">Join Us</router-link>
            </li>
            <li class="nav-item" v-if="!session">
              <router-link to="/login" class="nav-link" @click="closeMobileMenu">Login</router-link>
            </li>
            <li class="nav-item dropdown" v-else>
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                {{ session.firstName || session.email }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><router-link to="/my-activities" class="dropdown-item" v-if="session && session.role !== 'admin'">My Activities</router-link></li>
                <li><router-link to="/admin" class="dropdown-item" v-if="session && session.role==='admin'">Admin</router-link></li>
                <li><hr class="dropdown-divider" v-if="session && session.role !== 'admin'"></li>
                <li><button class="dropdown-item" @click="onLogout">Logout</button></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </template>

  <script>
  import { ref, onMounted, onUnmounted } from 'vue'
  import { getSession, logout } from '../utils/auth.js'

  export default {
    name: 'NavigationComponent',
    setup() {
      const showMobileMenu = ref(false)
      const session = ref(getSession())

      const updateSession = () => {
        const newSession = getSession()
        session.value = newSession
        console.log('Navigation session updated:', newSession) // Debug log
      }

      const handleUserLoggedIn = () => {
        console.log('User logged in event received') // Debug log
        updateSession()
      }

      const handleUserLoggedOut = () => {
        console.log('User logged out event received') // Debug log
        updateSession()
      }

      onMounted(() => {
        // Listen for login/logout events
        window.addEventListener('userLoggedIn', handleUserLoggedIn)
        window.addEventListener('userLoggedOut', handleUserLoggedOut)
        console.log('Navigation component mounted, current session:', session.value) // Debug log
      })

      onUnmounted(() => {
        window.removeEventListener('userLoggedIn', handleUserLoggedIn)
        window.removeEventListener('userLoggedOut', handleUserLoggedOut)
      })

      const toggleMobileMenu = () => {
        showMobileMenu.value = !showMobileMenu.value
      }

      const closeMobileMenu = () => {
        showMobileMenu.value = false
      }

      const onLogout = async () => {
        await logout()
        session.value = null
        closeMobileMenu()
        // Trigger logout event for other components
        window.dispatchEvent(new CustomEvent('userLoggedOut'))
        window.location.href = '/'
      }

      return {
        showMobileMenu,
        toggleMobileMenu,
        closeMobileMenu,
        session,
        onLogout
      }
    }
  }
  </script>
